// Generated by CoffeeScript 1.6.3
var Handler, deferred, http, lastInstance;

http = require('http');

Handler = require('./handler');

deferred = require('also').deferred;

lastInstance = void 0;

module.exports._test = function() {
  return lastInstance;
};

module.exports.create = function(config) {
  var local;
  return lastInstance = local = {
    server: void 0,
    handler: Handler.create(config).handle,
    status: {
      value: 'pending',
      at: new Date
    },
    listen: deferred(function(action, callback) {
      var hostname, listenArgs, port, server;
      if (!(function() {
        try {
          return listenArgs = config.www.listen;
        } catch (_error) {}
      })()) {
        return;
      }
      port = parseInt(listenArgs.port);
      hostname = listenArgs.hostname;
      local.server = server = http.createServer(function(req, res) {
        return local.handler(req, res);
      });
      server.on('error', function(error) {
        if (local.status.value === 'pending') {
          if (typeof callback === 'function') {
            callback(error);
          }
          return action.reject(error);
        }
      });
      return server.listen(port, hostname, function() {
        local.status.value = 'listening';
        local.status.at = new Date;
        if (typeof callback === 'function') {
          callback(null, local);
        }
        return action.resolve(local);
      });
    }),
    close: function(callback) {
      try {
        return local.server.close(callback);
      } catch (_error) {}
    }
  };
};
