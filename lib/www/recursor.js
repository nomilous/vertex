// Generated by CoffeeScript 1.6.3
var deferred;

deferred = require('decor').deferred;

module.exports.create = function(config, log) {
  var local, _base;
  config || (config = {});
  config.www || (config.www = {});
  (_base = config.www).routes || (_base.routes = {});
  return local = {
    process: deferred(function(action, opts) {
      var path;
      path = opts.path.split('/').filter(function(p) {
        return p.length > 0;
      });
      return local.recurse(opts, path, config.www.routes, function(error, result) {
        if (error != null) {
          return action.reject(error);
        }
        return action.resolve(result);
      });
    }),
    recurse: function(opts, path, object, callback) {
      var error, run;
      try {
        run = function() {
          var nextKey;
          if (nextKey = path.shift()) {
            if (!(object = object[nextKey])) {
              return callback(null, {
                statusCode: 404
              });
            }
            return local.recurse(opts, path, object, callback);
          } else {
            return callback(null, {
              statusCode: 200,
              body: object
            });
          }
        };
        if ((path[0] != null) && (object[path[0]] != null) && path[0] !== '$www') {
          return run();
        } else if (typeof object === 'function') {
          if (!object.$www) {
            return callback(null, {
              statusCode: 404
            });
          }
          opts.rest = path;
          opts.www = object.$www;
          return object(opts, function(error, result) {
            if (error != null) {
              return callback(error);
            }
            if ((result.body != null) || (result.statusCode != null)) {
              return callback(null, {
                statusCode: result.statusCode || 200,
                headers: result.headers,
                body: result.body || '',
                www: object.$www
              });
            }
            object = result;
            return run();
          });
        } else {
          return run();
        }
      } catch (_error) {
        error = _error;
        return callback(error);
      }
    }
  };
};
